generator client {
  provider = "prisma-client-js"
  engineType = "library"
}

datasource db {
  provider = "postgresql"
}


// Enums
enum OrderStatus {
  PENDING
  PAID
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
  REFUNDED

  @@map("order_status")
}

// Models
// Models
model Role {
  id          Int      @id @default(autoincrement())
  name        String   @unique @db.VarChar(50)
  permissions Json     @default("[]")
  users       User[]
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @default(now()) @updatedAt @map("updated_at")

  @@map("roles")
}

model User {
  id           String   @id @default(uuid()) @db.Uuid
  email        String   @unique @db.VarChar(255)
  passwordHash String   @map("password_hash") @db.VarChar(255)
  name         String   @db.VarChar(100)
  avatar       String?  @db.VarChar(500)
  roleId       Int      @map("role_id")
  address      String?  @db.Text
  phone        String?  @db.VarChar(20)
  isActive     Boolean  @default(true) @map("is_active")
  role         Role     @relation(fields: [roleId], references: [id], onDelete: Restrict)
  orders       Order[]
  reviews      Review[]
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @default(now()) @updatedAt @map("updated_at")

  @@map("users")
}

model Category {
  id          String     @id @default(uuid()) @db.Uuid
  name        String     @db.VarChar(100)
  slug        String     @unique @db.VarChar(150)
  image       String?    @db.VarChar(500)
  description String?
  isActive    Boolean    @default(true) @map("is_active")
  parentId    String?    @map("parent_id") @db.Uuid
  parent      Category?  @relation("CategoryToCategory", fields: [parentId], references: [id], onDelete: SetNull)
  children    Category[] @relation("CategoryToCategory")
  products    Product[]
  createdAt   DateTime   @default(now()) @map("created_at")
  updatedAt   DateTime   @default(now()) @updatedAt @map("updated_at")

  @@map("categories")
}

model Product {
  id          String      @id @default(uuid()) @db.Uuid
  name        String      @db.VarChar(200)
  slug        String      @unique @db.VarChar(250)
  price       Decimal     @db.Decimal(10, 2)
  description String?
  stock       Int         @default(0)
  categoryId  String      @map("category_id") @db.Uuid
  images      String[]
  partitions  Json        @default("{}")
  isActive    Boolean     @default(true) @map("is_active")
  sku         String?     @unique @db.VarChar(100)
  weight      Decimal?    @default(0) @db.Decimal(8, 2)
  category    Category    @relation(fields: [categoryId], references: [id], onDelete: Restrict)
  orderItems  OrderItem[]
  reviews     Review[]
  createdAt   DateTime    @default(now()) @map("created_at")
  updatedAt   DateTime    @default(now()) @updatedAt @map("updated_at")

  @@map("products")
}

model Order {
  id              String      @id @default(uuid()) @db.Uuid
  userId          String      @map("user_id") @db.Uuid
  total           Decimal     @db.Decimal(12, 2)
  status          OrderStatus @default(PENDING)
  shippingAddress Json        @map("shipping_address")
  billingAddress  Json?       @map("billing_address")
  paymentMethod   String?     @map("payment_method") @db.VarChar(50)
  paymentId       String?     @map("payment_id") @db.VarChar(100)
  shippingCost    Decimal?    @default(0) @map("shipping_cost") @db.Decimal(10, 2)
  tax             Decimal?    @default(0) @db.Decimal(10, 2)
  notes           String?
  user            User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  orderItems      OrderItem[]
  reviews         Review[]
  createdAt       DateTime    @default(now()) @map("created_at")
  updatedAt       DateTime    @default(now()) @updatedAt @map("updated_at")
  shippedAt       DateTime?   @map("shipped_at")
  deliveredAt     DateTime?   @map("delivered_at")

  @@map("orders")
}

model OrderItem {
  id               String   @id @default(uuid()) @db.Uuid
  orderId          String   @map("order_id") @db.Uuid
  productId        String   @map("product_id") @db.Uuid
  quantity         Int
  price            Decimal  @db.Decimal(10, 2)
  selectedVariants Json     @default("{}") @map("selected_variants")
  subtotal         Decimal? @db.Decimal(10, 2) // Optional because it is generated in DB
  order            Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product          Product  @relation(fields: [productId], references: [id], onDelete: Restrict)
  createdAt        DateTime @default(now()) @map("created_at")

  @@unique([orderId, productId, selectedVariants])
  @@map("order_items")
}

model Review {
  id                 String   @id @default(uuid()) @db.Uuid
  userId             String   @map("user_id") @db.Uuid
  productId          String   @map("product_id") @db.Uuid
  orderId            String   @map("order_id") @db.Uuid
  rating             Int
  comment            String   @db.Text
  isVerifiedPurchase Boolean  @default(true) @map("is_verified_purchase")
  isApproved         Boolean  @default(true) @map("is_approved")
  user               User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  product            Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  order              Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  createdAt          DateTime @default(now()) @map("created_at")
  updatedAt          DateTime @default(now()) @updatedAt @map("updated_at")

  @@unique([userId, productId, orderId])
  @@map("reviews")
}